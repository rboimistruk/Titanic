---
title: "Titanic [Exploratory Analysis]"
author: "Roman Boimistruk"
date: "December 29, 2017"
output: html_document
---

###1. Loading the data and packages

```{r libraries, include=FALSE}
library(ggplot2) #gprahs
library(knitr)
library(dplyr)#piping operator + data manipulation
library(gridExtra) #plot multiple charts 
library(Amelia) #plot a heatmap with missinn values
library(caret) #models
```

```{r data}
train <- read.csv("train.csv")
```

###2. Data Overview

```{r giveninfo, echo = F}
kable(data.frame(Variable = c("PassengerId", "Survived", "Pclass", "Name", "Sex", "Age", "SibSp", "Parch", "Ticket", "Fare", "Cabin", "Embarked"),
           Definition = c("PassengerId", "Survival", "Ticket Class", "Name", "Sex", "Age", "# of siblings / spouses aboard", "# of parents / children aboard", 
                          "Ticket number", "PAssenger fare", "Cabin number", "Port of Embarkation"),
           Key = c("", "1 = Yes, 0 = No", "1 = 1st, 2 = 2nd, <br>3 = 3rd", "", "", "", "", "", "", "", "", "C = Cherbourg, <br>Q = Queenstown, <br>S = Southampton"),
           Notes = c("", "", "A proxy for socio-economic status (SES) <br>1st = Upper, 2nd = Middle, 3rd = Lower", "", "", 
                     "Age is fractional if less than 1. <br>If the age is estimated, is it in the form of xx.5", 
                     "Sibling = brother, sister, stepbrother, stepsister, <br>Spouse = husband, wife (mistresses and fiancés were ignored)",
                     "Parent = mother, father, <br>Child = daughter, son, stepdaughter, stepson, <br>Some children travelled only with a nanny, therefore parch=0 for them",
                     "", "", "", "")))
```

###3. Summary of the data

```{r summary}
str(train)
summary(train)
```

```{r}
head(train)
tail(train)
```

###4. Exploratory Analysis

Alright, we got an idea about our training dataset.
We can see from summary analysis that we hava some NAs (or missing values). Let's check again with NAs plot using *missmpa function*:

```{r NA plot, fig.width=7, fig.height=3}
missmap(train, col = c("white","darkblue"), legend = F,  main = "Missing Values")
```

So only Age varibale has some NAs which we should either ignore or replace with the actual values. Embarked and Cabin variables have also some empty values.

Let's start with the simple stuff and replace Embarked empty values with "S" - the most popular value.

```{r}
train$Embarked[train$Embarked == ""] <- "S"
```

To fill Age NAs I'm gonna use random forest to predict the Age based on other characteristics
```{r}
train$Age.old <- train$Age
fit <- train(Age~Survived + Pclass + Sex + Embarked + SibSp + Parch + Fare, data = train[!is.na(train$Age),], method="rf", trControl=trainControl(method="cv", number=10))
new <- cbind(train[is.na(train$Age),], predict(fit, train[is.na(train$Age),]))
train$Age[is.na(train$Age)] <- new[,14]
train$Age <- as.numeric(train$Age)
```
```{r}
summary(train$Age)
summary(train$Embarked)
```


Now, let's visualise all variables and highlight Survivals vs. Non-Survivals among each of the characteristics to see if there is any correlation.

```{r plot, fig.width=17, fig.height=10}
p1 <- ggplot(data = train, aes(as.factor(Pclass), fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Ticket Class") +
     ggtitle("Survivals by the Ticket Class") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))

p2 <- ggplot(data = train, aes(as.factor(SibSp), fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Number of Siblings") +
     ggtitle("Survivals by the number of siblings/spouses") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))

p3 <- ggplot(data = train, aes(as.factor(Parch), fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Number of Parents/Children") +
     ggtitle("Survivals by the number of Parents/Children") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))

p4 <- ggplot(data = train, aes(Sex, fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Sex") +
     ggtitle("Survivals by the sex") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))

p5 <- ggplot(data = train, aes(Age, fill = as.factor(Survived))) +
     geom_histogram(bins = 15) +
     labs(x = "Number of Siblings") +
     ggtitle("Survivals by age") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))

p6 <- ggplot(data = train, aes(Embarked, fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Port of Embarkation") +
     ggtitle("Survivals by port of Embarkation") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))

grid.arrange(p1,p2,p3,p4,p5,p6)
```

From the first glance at the data we can see some clear patterns. For instance, there is strong correlation between **Ticket class**/**Sex** and **Survival rate** - Females were more likely to survive as well as people from the first class.



##5. Feature Engineering

Let's see what else can we get from the data.

###5.1 Titles

```{r}
head(train$Name)
tail(train$Name)
```

We can see the pattern that each name includes the passanger title (Mr., Mrs., Master etc.). Let's extract this infrmation and create a new variable **Title**:


```{r}
train$Title[grepl("Mr\\.", train$Name, ignore.case = T)] <- "Mr"
train$Title[grepl("Miss\\.|Mlle\\.|Ms\\.|Mme\\.", train$Name, ignore.case = T)] <- "Miss" 
train$Title[grepl("Mrs\\.", train$Name, ignore.case = T)] <- "Mrs"   
train$Title[grepl("Master\\.", train$Name, ignore.case = T)] <- "Master"  
train$Title[grepl("Don\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Rev\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Dr\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Capt\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Col\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Sir\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Major\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Jonkheer\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Countess\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title[grepl("Lady\\.", train$Name, ignore.case = T)] <- "Rare"
train$Title <- as.factor(train$Title)
```


```{r}
summary(train$Title)
```

```{r }
p7 <- ggplot(data = train, aes(as.factor(Title), fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Title") +
     ggtitle("Survivals by the Title") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))
```

###5.2 Tickets

```{r}
head(train$Ticket)
tail(train$Ticket)
```

Each ticket consist of some digits and, in some cases, some letters. Let's disregards all letters and group all tickets only based om the first digit:

```{r}
train$Ticket.n[grepl("^1", gsub("[^0-9\\|]", "", train$Ticket))] <- 1
train$Ticket.n[grepl("^2", gsub("[^0-9\\|]", "", train$Ticket))] <- 2
train$Ticket.n[grepl("^3", gsub("[^0-9\\|]", "", train$Ticket))] <- 3
train$Ticket.n[grepl("^4", gsub("[^0-9\\|]", "", train$Ticket))] <- 4
train$Ticket.n[grepl("^5", gsub("[^0-9\\|]", "", train$Ticket))] <- 5
train$Ticket.n[grepl("^6", gsub("[^0-9\\|]", "", train$Ticket))] <- 6
train$Ticket.n[grepl("^7", gsub("[^0-9\\|]", "", train$Ticket))] <- 7
train$Ticket.n[grepl("^8", gsub("[^0-9\\|]", "", train$Ticket))] <- 8
train$Ticket.n[grepl("^9", gsub("[^0-9\\|]", "", train$Ticket))] <- 9
train$Ticket.n[train$Ticket == "LINE"] <- "Line"
train$Ticket.n <- as.factor(train$Ticket.n)
```

```{r}
summary(train$Ticket.n)
```
```{r}
ggplot(data = train, aes(as.factor(Ticket.n), fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Ticket Number") +
     ggtitle("Survivals by the Ticket") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))
```

###5.3 Age groups - Kids & Adults

We've already cleaned Age values so let's just group them up into categories:

```{r}
train$Age.n[train$Age < 5] <- "<5"
train$Age.n[train$Age < 10 & train$Age >= 5] <- "5-10"
train$Age.n[train$Age < 20 & train$Age >= 10] <- "10-20"
train$Age.n[train$Age < 25 & train$Age >= 20] <- "20-25"
train$Age.n[train$Age < 28 & train$Age >= 25] <- "25-27"
train$Age.n[train$Age < 30 & train$Age >= 28] <- "28-29"
train$Age.n[train$Age < 33 & train$Age >= 30] <- "30-31"
train$Age.n[train$Age < 35 & train$Age >= 33] <- "32-34"
train$Age.n[train$Age < 40 & train$Age >= 35] <- "35-40"
train$Age.n[train$Age < 50 & train$Age >= 40] <- "40-50"
train$Age.n[train$Age < 100 & train$Age >= 50] <- "50+"
train$Age.n <- as.factor(train$Age.n)
train$Age.n <- factor(train$Age.n, levels = c("<5", "5-10", "10-20", "20-25", "25-27", "28-29", "30-31", "32-34", "35-40", "40-50", "50+"))
```

```{r}
ggplot(data = train, aes(as.factor(Age.n), fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Age groups") +
     ggtitle("Survivals by the Age groups") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))
```

Using the same principles we can create a new column **Kid** for passengers who are yonger than 14. 


```{r}
train$Kid <- "Adult"
train$Kid[train$Age < 14] <- "Kid"
train$Kid <- as.factor(train$Kid)
```

```{r}
ggplot(data = train, aes(Kid, fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Kid or Adult") +
     ggtitle("Survivals by Kid/Adult") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))
```


###5.4 Familty Size

Let's just combined siblings, parents, children and spouses together in the new variable **Family Size**
```{r}
train$FamilySize <- train$SibSp + train$Parch
train$FamilySize <- as.factor(train$FamilySize)
```

```{r }
ggplot(data = train, aes(FamilySize, fill = as.factor(Survived))) +
     geom_bar(position = 'fill') +
     labs(x = "Familty Size") +
     ggtitle("Survivals by Family Size") +
     scale_fill_discrete(name = "Survived",
                         breaks = c(0,1),
                         labels = c("No", "Yes")) +
     theme(legend.position="top", plot.title = element_text(hjust = 0.5))

```

##6. Predictions

Creating validation data set

```{r}
trainIndex <- createDataPartition(train$Survived, p=0.8, list=FALSE) #Split the data 20/80
data_train <- train[ trainIndex,]
data_val <- train[-trainIndex,]
```

Assigning Control and Metic characteristics. I will use 10-fold Cross Validation and we want our model to show us its Accuracy and Kappa.
```{r}
control <- trainControl(method="cv", number=10)
metric <- "Accuracy"
```

###6.1. Linear Discriminant Analysis
```{r}
set.seed(7)
fit.lda <- train(as.factor(Survived)~Pclass+Title+Age+Fare, data = data_train, method="lda", metric=metric, trControl=control)
fit.lda
```

###6.2. Classification and Regression Trees
```{r}
set.seed(7)
fit.cart <- train(as.factor(Survived)~Pclass+Title+Age+Fare, data = data_train, method="rpart", metric=metric, trControl=control)
fit.cart
```

###6.3. k-Nearest Neighbors
```{r}
set.seed(7)
fit.knn <- train(as.factor(Survived)~Pclass+Title+Age+Fare, data = data_train, method="knn", metric=metric, trControl=control)
fit.knn
```

###6.4. Support Vector Machines (SVM)
```{r}
set.seed(7)
fit.svm <- train(as.factor(Survived)~Pclass+Title+Age+Fare, data = data_train, method="svmRadial", metric=metric, trControl=control)
fit.svm
```

###6.5. Random Forest
```{r}
set.seed(7)
fit.rf <- train(as.factor(Survived)~Pclass+Title+Age+Fare, data = data_train, method="rf", metric=metric, trControl=control)
fit.rf
```

###6.6. Logistics Regression
```{r}
set.seed(7)
fit.glm <- train(as.factor(Survived)~Pclass+Title+Age+Fare, data = data_train, method="glm", metric=metric, trControl=control)
fit.glm
```

###6.7 Results
Let's look at the results of all our models and plot the graph with Accuracy/Kappa.

```{r}
results <- resamples(list(lda=fit.lda, cart=fit.cart, knn=fit.knn, svm=fit.svm, rf=fit.rf, glm = fit.glm))
summary(results)
dotplot(results)
```

Ploting confusion matrix on the Random Forest and SVM models

```{r}
confusionMatrix(predict(fit.rf, data_val), data_val$Survived)
confusionMatrix(predict(fit.svm, data_val), data_val$Survived)
```

As we can see Random Forest has higher Accuracy.
So lets try our model to the test set. BNut before this I'm gonna apply all the changes to the test data set that I applied to training (another option is to combine both data sets together and identify them by the new variable).

```{r}
test <- read.csv("test.csv")
```

```{r include=FALSE}

test <- read.csv("test.csv")
#Replace missing data from Embarked with "S"
test$Fare[is.na(test$Fare)] <- mean(test$Fare, na.rm = T)
#Age Predictions
test$Age.old <- test$Age
train.age <- test[!is.na(test$Age),]
test.age <- test[is.na(test$Age),]
fit <- train(Age~Pclass + Sex + Embarked + SibSp + Parch + Fare, data = train.age, method="rf", trControl=trainControl(method="cv", number=10))
new <- cbind(test.age, predict(fit, test.age))
test$Age[is.na(test$Age)] <- new[,13]
test$Age <- round(as.numeric(test$Age),0)
#Assignings titles to all passangers
test$Title[grepl("Mr\\.", test$Name, ignore.case = T)] <- "Mr"
test$Title[grepl("Miss\\.|Mlle\\.|Ms\\.|Mme\\.", test$Name, ignore.case = T)] <- "Miss" 
test$Title[grepl("Mrs\\.", test$Name, ignore.case = T)] <- "Mrs"   
test$Title[grepl("Master\\.", test$Name, ignore.case = T)] <- "Master"  
test$Title[grepl("Don\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Rev\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Dr\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Capt\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Col\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Sir\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Major\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Jonkheer\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Countess\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[grepl("Lady\\.", test$Name, ignore.case = T)] <- "Rare"
test$Title[is.na(test$Title)] <- "Rare"
test$Title <- as.factor(test$Title)
#Creating a new column "Ticket.n" and assigning to it the first number of the ticket
test$Ticket.n[grepl("^1", gsub("[^0-9\\|]", "", test$Ticket))] <- 1
test$Ticket.n[grepl("^2", gsub("[^0-9\\|]", "", test$Ticket))] <- 2
test$Ticket.n[grepl("^3", gsub("[^0-9\\|]", "", test$Ticket))] <- 3
test$Ticket.n[grepl("^4", gsub("[^0-9\\|]", "", test$Ticket))] <- 4
test$Ticket.n[grepl("^5", gsub("[^0-9\\|]", "", test$Ticket))] <- 5
test$Ticket.n[grepl("^6", gsub("[^0-9\\|]", "", test$Ticket))] <- 6
test$Ticket.n[grepl("^7", gsub("[^0-9\\|]", "", test$Ticket))] <- 7
test$Ticket.n[grepl("^8", gsub("[^0-9\\|]", "", test$Ticket))] <- 8
test$Ticket.n[grepl("^9", gsub("[^0-9\\|]", "", test$Ticket))] <- 9
test$Ticket.n[test$Ticket == "LINE"] <- "Line"
test$Ticket.n <- as.factor(test$Ticket.n)
#Creating a new variable with Age groups
test$Age.n[test$Age < 5] <- "<5"
test$Age.n[test$Age < 10 & test$Age >= 5] <- "5-10"
test$Age.n[test$Age < 20 & test$Age >= 10] <- "10-20"
test$Age.n[test$Age < 25 & test$Age >= 20] <- "20-25"
test$Age.n[test$Age < 28 & test$Age >= 25] <- "25-27"
test$Age.n[test$Age < 30 & test$Age >= 28] <- "28-29"
test$Age.n[test$Age < 33 & test$Age >= 30] <- "30-31"
test$Age.n[test$Age < 35 & test$Age >= 33] <- "32-34"
test$Age.n[test$Age < 40 & test$Age >= 35] <- "35-40"
test$Age.n[test$Age < 50 & test$Age >= 40] <- "40-50"
test$Age.n[test$Age < 100 & test$Age >= 50] <- "50+"
test$Age.n <- as.factor(test$Age.n)
test$Age.n <- factor(test$Age.n, levels = c("<5", "5-10", "10-20", "20-25", "25-27", "28-29", "30-31", "32-34", "35-40", "40-50", "50+"))
#Kid or Adult
test$Kid <- "Adult"
test$Kid[test$Age < 18] <- "Kid"
test$Kid <- as.factor(test$Kid)
#FamilySize
test$FamilySize <- test$SibSp +test$Parch
test$FamilySize <- as.factor(test$FamilySize)
#Chagning the class of some variables to factor
test$Pclass <- as.factor(test$Pclass)
test$Sex <- as.factor(test$Sex)
```

Now I'm gonna use Random Forest model to fit on test data set to predict Survivals:

```{r}
fit.rf <- train(as.factor(Survived)~as.factor(Pclass)+Title+Age+Fare, data = train, method="rf", metric=metric, trControl=control)
predictions <- predict(fit.rf, test)
x <- cbind(test$PassengerId, as.data.frame(predictions))
colnames(x) <- c("PassengerID", "Survived")
write.csv(x, "test.csv", row.names = F)
```

We got **75.12%** after submitting on kaggle.
